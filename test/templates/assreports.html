<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assessment Report</title>
    <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
  />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
  />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.21/jspdf.plugin.autotable.min.js"></script>

    <!-- <canvas id="caseChart" width="600" height="400"></canvas> -->
    <style>
        /* General Reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Body Style */
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
            color: #333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 20px;
        }

        /* Heading */
        h2 {
            text-align: center;
            color: #4CAF50;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        /* Form */
        form {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 600px;
            padding: 20px;
        }

        .form-row {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }

        .form-group {
            flex: 1;
        }

        label {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }

        select, input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .button-rep {
            display: block;
            width: 100%;
            background-color: #4CAF50;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        .cancel-btn, .button-rep {
    flex: 1; /* Makes both buttons take equal space */
    padding: 12px 20px;
    font-size: 16px;
    font-weight: bold;
    text-align: center;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

.cancel-btn {
    background-color: red;
    color: white;
}

.button-rep {
    background-color: rgb(10, 124, 211);
    color: white;
}

.cancel-btn:hover {
    background-color: rgb(189, 14, 14);
}

.button-rep:hover {
    background-color: rgb(5, 105, 181);
}

        button:hover {
            background-color: #45a049;
        }

        /* Report Table */
        .report-container {
            margin-top: 20px;
            width: 100%;
            max-width: 600px;
            overflow-x: auto;
            max-height: 400px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            background-color: white;
        }

        th, td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: center;
        }

        th {
            background-color: #4CAF50;
            color: white;
        }

        /* Chart Section */
        .chart-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
            margin-bottom: 30px;
            flex-wrap: wrap; /* Ensures wrapping on smaller screens */
        }

        .chart-box {
            width: 100%;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            
        }
        .header {
        background-color: #2eba41;
        color: white;
        padding: 10px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
        z-index: 1001;
        display: none;
      }

      .burger-button {
        font-size: 24px;
        background: none;
        border: none;
        color: white;
        cursor: pointer;
      }

      /* Sidebar */
      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        background-color: #2c3e50;
        overflow-y: auto;
        transition: transform 0.3s ease;
        box-shadow: 2px 0 5px rgba(0, 0, 0, 0.2);
        z-index: 1000;
      }

      .sidebar.closed {
        transform: translateX(-100%);
      }

      .sidebar-header {
    background-color:  #2eba41; /* Dark blue-gray */
    color: white;
    padding: 14px 20px;
    display: flex;
    justify-content: space-between; /* Pushes elements apart */
    align-items: center;
}

.hello-text {
    font-size: 18px;
    font-weight: bold;
    background-color: #2eba41; /* Green background */
    color: white;
    padding: 5px 15px; /* Adds spacing */
    border-radius: 5px; /* Rounded corners */
    margin-right: 10px; /* Space between text and button */
}

.close-button {
    background-color: #f44336; /* Red background */
    color: white;
    border: none;
    padding: 5px 15px;
    font-size: 16px;
    cursor: pointer;
    border-radius: 5px;
}

.close-button:hover {
    background-color: darkred; /* Darker red on hover */
}

      .menu {
        list-style: none;
        padding: 0;
      }

      .menu-item {
        padding: 10px 20px;
        cursor: pointer;
        position: relative;
        color: white;
        background-color: #2c3e50;
      }

      .menu-item:hover {
        background-color: #000000;
      }

      .menu-item .arrow {
        float: right;
        transition: transform 0.3s;
      }

      .menu-item.open .arrow {
        transform: rotate(90deg);
      }

      .submenu {
        display: none;
        list-style: none;
        padding-left: 20px;
        background-color: #34495e;
       
      }

      .submenu li {
        padding: 5px 20px;
        color: #ecf0f1;
      }

      .submenu li:hover {
        background-color: #000000;
      }

      .menu-item.open .submenu {
        display: block;
      }

      /* Main Content */
      .content {
        align-items: center;
        margin-left: 250px;
        padding: 20px;
        transition: margin-left 0.3s ease;
      }

      .sidebar.closed + .content {
        margin-left: 0;
      }
      ul {
        list-style: none;
        padding: 0;
      }

      ul li {
        margin: 10px 0;
        font-size: 1.1rem;
      }

      ul li input[type="checkbox"] {
        margin-right: 10px;
      }

      #commentModal button {
    padding: 8px 14px;
    font-size: 14px;
    font-weight: bold;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.25s ease;
}

/* Cancel button */
#commentModal button:first-child {
    background-color: #dc3545; /* red */
    color: white;
}

#commentModal button:first-child:hover {
    background-color: #b52a37;
}

/* Submit button */
#commentModal button:last-child {
    background-color: #28a745; /* green */
    color: white;
}

#commentModal button:last-child:hover {
    background-color: #218838;
}

.pdf_sl_no{
         background-color: #28a745; /* Green background */
  color: white;              /* White text */
  padding: 10px 18px;        /* Padding around text */
  border: none;              /* No border */
  border-radius: 6px;        /* Rounded corners */
  font-size: 14px;           /* Text size */
  cursor: pointer;           /* Pointer cursor on hover */
  transition: background-color 0.3s ease;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      }

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

        /* Responsive Behavior */
        @media (max-width: 768px) {
            .welcome-text {
        font-size: 1.2em; /* Same as H3 */
    }
        .sidebar {
          transform: translateX(-100%);
          width: 250px;
        }
        .container {
          max-width: 100%; 
          padding: 12px; 
        }
        .sidebar.open {
          transform: translateX(0);
        }

        .content {
          margin-left: 0;
        }
    }
        /* Responsive Design */
        @media (max-width: 768px) {
            .chart-container {
                flex-direction: column;
                align-items: center;
            }

            .chart-box {
                width: 100%; /* Full width on mobile */
                max-width: 600px;
            }
        }
    </style>
</head>

<body>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <header class="header">
      <span class="welcome-message">
        <h2 class="welcome-text">üòä Welcome, {{ username }}! üåü</h2>
    </span>

      <button id="burger-button" class="burger-button">&#9776;</button>
    </header>
    <div id="sidebar" class="sidebar">
      <div class="sidebar-header">
        <span class="hello-text">Hello, {{ username }}! </span>
        <button id="close-button" class="close-button">&times;</button>
      </div>
      <ul class="menu">
        {% if user_type == 'Admin' %}
        <li class="menu-item open" >
          Masters <span class="arrow ">&#9654;</span>
          <ul class="submenu">
            <li class="menu-item" style="display: flex; justify-content: space-between; align-items: center;">
              Customer
              <span class="icons" style="margin-left: 20px; display: flex; justify-content: flex-end; gap: 10px;">
                <button class="create-btn" style="color: blue;" onclick="window.location.href='/customer'"title="Create">
                  <i class="fas fa-plus"></i>
                </button>
                <button class="update-btn" onclick="window.location.href='/updatecustomer'"title="Update">
                  <i class="fas fa-edit"></i>
                </button>
              </span>
            </li>
            
            <li class="menu-item" style="display: flex; justify-content: space-between; align-items: center;">
              Site
              <span class="icons" style="margin-left: 20px; display: flex; justify-content: flex-end; gap: 10px;">
                <button class="create-btn" style="color: blue;" onclick="window.location.href='/site'" title="Create">
                  <i class="fas fa-plus"></i>
                </button>
                <button class="update-btn" onclick="window.location.href='/updatesite'" title="Update">
                  <i class="fas fa-edit"></i>
                </button>
              </span>
            </li>
            
            <li class="menu-item" style="display: flex; justify-content: space-between; align-items: center;">
              Users
              <span class="icons" style="margin-left: 20px; display: flex; justify-content: flex-end; gap: 10px;">
                <button class="create-btn"style="color: blue;" onclick="window.location.href='/userform'" title="Create">
                  <i class="fas fa-plus"></i>
                </button>
                <button class="update-btn" onclick="window.location.href='/updateusers'"title="Update">
                  <i class="fas fa-edit"></i>
                </button>
              </span>
            </li>
            
            
          </ul>
        </li>
        {% endif %}
        <li class="menu-item" style="display: flex; justify-content: space-between; align-items: center;">
          Assessment
          <span class="icons" style="margin-left: 20px; display: flex; justify-content: flex-end; gap: 10px;">
            {% if user_type=='Admin' %}
            <button class="create-btn"style="color: blue;" onclick="window.location.href='/assessment'" title="Create">
              <i class="fas fa-plus"></i>
            </button>
            {% endif %}
            <button class="update-btn" onclick="window.location.href='/updateassmnt'"title="Update">
              <i class="fas fa-edit"></i>
            </button>
         
          </span>
        </li>
        
        <li class="menu-item" style="display: flex; justify-content: space-between; align-items: center;">
          Remedy
          <span class="icons" style="margin-left: 20px; display: flex; justify-content: flex-end; gap: 10px;">
            {% if user_type=='Admin' %}
            <button class="create-btn"style="color: blue;" onclick="window.location.href='/remedy'" title="Create">
              <i class="fas fa-plus"></i>
            </button>
            {% endif %}
            <button class="update-btn" onclick="window.location.href='/updateremedy'"title="Update">
              <i class="fas fa-edit"></i>
            </button>
         
          </span>
        </li>
        <li class="menu-item">
          Inventory <span class="arrow">&#9654;</span>
          <ul class="submenu">
            <li class="menu-item" style="display: flex; justify-content: space-between; align-items: center;">
              Inventory 
              <span class="icons" style="margin-left: 20px; display: flex; justify-content: flex-end; gap: 10px;">
                <button class="create-btn"style="color: blue;" onclick="window.location.href='/inventory'" title="Create">
                  <i class="fas fa-plus"></i>
                </button>
                <button class="update-btn" onclick="window.location.href='/updateinventory'"title="Update">
                  <i class="fas fa-edit"></i>
                </button>
             
              </span>
            </li>
            <li class="menu-item" style="display: flex; justify-content: space-between; align-items: center;">
              Inventory Trans
              <span class="icons" style="margin-left: 20px; display: flex; justify-content: flex-end; gap: 10px;">
                <button class="create-btn"style="color: blue;" onclick="window.location.href='/invtrans'" title="Create">
                  <i class="fas fa-plus"></i>
                </button>
                <button class="update-btn" onclick="window.location.href='/updateinvtrans'"title="Update">
                  <i class="fas fa-edit"></i>
                </button>
             
              </span>
            </li>
          </ul>
        </li>
        
        </li>
        <li class="menu-item " >
          Reports <span class="arrow ">&#9654;</span>
          <ul class="submenu">
            <li class="menu-item" onclick="window.location.href='/reports'" style="display: flex; justify-content: space-between; align-items: center;">
              Assessment 
              <i class="fas fa-chart-bar" style="margin-left: 10px;"></i>
    
              
            </li>
            <li class="menu-item" onclick="window.location.href='/remedyreports'" style="display: flex; justify-content: space-between; align-items: center;">
              Remedy 
              <i class="fas fa-chart-line" style="margin-left: 10px;"></i>
    
              
            </li>
            <li class="menu-item" onclick="window.location.href='/reporthtml'" style="display: flex; justify-content: space-between; align-items: center;">
                HTML Report
                <i class="fas fa-chart-bar" style="margin-left: 10px;"></i>
      
              </li>
            </ul>
            </li>
        
        <li class="menu-item" onclick="window.location.href='/profile'" style="display: flex; justify-content: space-between; align-items: center;">
          Profile
          <i class="fas fa-user" style="margin-left: 10px;"></i>
        </li>
        <li class="menu-item" onclick="window.location.href='/'" style="display: flex; justify-content: space-between; align-items: center;">
          Logout
          <i class="fas fa-sign-out-alt" style="margin-left: 10px;"></i>
        </li>
      </ul>
    </div>
    <h2>Allotment of Assessments</h2>

    <form id="reportForm">
        <!-- First Row -->
        <div class="form-row">
            <div class="form-group">
                <label for="area">Select Area:</label>
                <select id="area" name="area">
                    <option value="all">All Areas</option>
                    <option value="A001">Area 1</option>
                    <option value="A002">Area 2</option>
                    <option value="A003">Area 3</option>
                    <option value="A004">Area 4</option>
                    <option value="A005">Area 5</option>
                </select>
            </div>

            <div class="form-group">
                <label for="user_id">Select User <span class="required">*</span></label>
                <select id="user_id" name="user_id" required>
                    <option value="" disabled selected>Select User</option>
                </select>
            </div>
        </div>

        <!-- Second Row -->
        <div class="form-row">
            <div class="form-group">
                <label for="from_date">From Date:</label>
                <input type="date" id="from_date" name="from_date">
            </div>

            <div class="form-group">
                <label for="to_date">To Date:</label>
                <input type="date" id="to_date" name="to_date">
            </div>
            <div class="form-group">
                <label for="completed_date">Completed Date:</label>
                <input type="date" id="completed_date" name="completed_date">
            </div>
        </div>
        </div>
        <div class="form-row">
        <div class="form-group">
            <label for="assessment_status">Assessment Status<span class="required">*</span></label>
            <select id="assessment_status" name="assessment_status" required>
                <option value="" disabled selected>Select Status</option>
                <!--<option value="None">None</option>-->
                <option value="All Status">All Status</option>
                <option value="In progress">In Progress</option>
                <option value="Completed">Completed</option>
                <option value="PM Approved">PM Approved</option>
                <option value="OE Approved">OE Approved</option>
            </select>
        </div>
        <div class="form-group">
            <label for="picture_location">Picture Location:</label>
            <select id="picture_location">
                <option value="">All</option>
                <option value="not_null">Present</option>
                <option value="null">Not Present</option>
            </select>

        </div>
       
        <div class="form-group"><button ></button><button class="button-rep" type="button" onclick="generateReport()">Get Report</button></div>
    </div>
 
<div id="commentModal" style="
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #fff;
    padding: 20px;
    width: 250px;
    border-radius: 15px;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
    z-index: 9999;
">
    <h3 style="margin-bottom: 10px;">Add Comment</h3>
    <textarea id="modalCommentText" style="width: 100%; height: 80px;"></textarea>
    <div style="margin-top: 10px; display: flex; justify-content: flex-end; gap: 10px;">
        <button type = "button" onclick="cancelModal()">Cancel</button>
        <button type = "button"onclick="submitModalComment()">Submit</button>
    </div>
</div>

<div id="commentPopup" style="
    display: none;
    position: fixed;
    top: 20px;
    left: 50%;
    text-align: center;
    width: 100%;
    max-width: 400px;
    background-color: #4caf50;
    transform: translateX(-50%);
    padding: 20px;
    border-radius: 8px;
    font-size: 16px;
    z-index: 1000;
">
    Comment submitted successfully
</div>
    <div class="report-container">
        <table id="reportTable">
          <thead>
    <tr>
        <th>User Name</th>
        <th>Table ID</th>
        <th>Pile No</th>
        <th>Task Date</th>
        <th>Area ID</th> <!-- ‚úÖ Added this -->
        <th>Assessment Status</th>
        <th>Assessment Case</th>
        <th>Pictures</th>
    </tr>
</thead>
        
            <tbody></tbody>
        </table>
    </div>

    <!-- Chart Section -->
    <div class="chart-container">
        <div class="chart-box"><canvas id="statusChart"></canvas></div>
        <div class="chart-box"><canvas id="caseChart"></canvas></div>
    </div>
   <div class="form-row">
          <!-- <button type="button" class="cancel-btn" onclick="window.location.href='/dashboard'">Cancel</button> -->
         <button type="button"  class="cancel-btn" onclick="savecasePDF()">Download Case Report</button>
         <button type="button" class="button-rep" onclick="saveFIPDF()">Download Reports</button>
        </div>
        <button type="button" class = "pdf_sl_no" onclick="generateAssSLNOFile()">PDF SL No</button>
</form>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.21/jspdf.plugin.autotable.min.js"></script>
<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>

<script>

fetch("/get_user_ids")
        .then((response) => response.json())
        .then((data) => {
            // Log the data to check its structure
    
            if (data.success) {
                const userSelect = document.getElementById("user_id");

                // Clear existing options
                userSelect.innerHTML = '';

                // Add "Select User" Placeholder
                const defaultOption = document.createElement("option");
                defaultOption.value = '';  
                defaultOption.textContent = 'Select User';  
                defaultOption.disabled = true;  
                defaultOption.selected = true;  
                userSelect.appendChild(defaultOption);

                // Add "All Users" Option
                const allUsersOption = document.createElement("option");
                allUsersOption.value = "all"; // Special value for all users
                allUsersOption.textContent = "All Users";
                userSelect.appendChild(allUsersOption);

                // Check if users exist in the response
                if (Array.isArray(data.users) && data.users.length > 0) {
                    data.users.forEach((user) => {
                        // Create options for "user_id"
                        const userOption = document.createElement("option");
                        userOption.value = user.id;  // Use User ID as the value
                        userOption.textContent = user.username;  // Display Username
                        userSelect.appendChild(userOption);
                    });
                } else {
                    console.error("No users found in the data.");
                }
            }

        })
        .catch((error) => console.error("Error fetching users:", error));

       function generateReport() {
    const userId = document.getElementById("user_id").value;
    const fromDate = document.getElementById("from_date").value;
    const toDate = document.getElementById("to_date").value;
    const completedDate = document.getElementById("completed_date").value;
    const assessmentStatus = document.getElementById("assessment_status").value;
    const areaId = document.getElementById("area").value;
    const pictureLocation = document.getElementById("picture_location").value;

    if (!userId) {
        alert("Please enter User ID.");
        return;
    }

    // ‚úÖ Either from/to date OR completed date must be filled
    if (!completedDate && (!fromDate || !toDate)) {
        alert("Please provide either 'From Date' and 'To Date' OR 'Completed Date'.");
        return;
    }

    // ‚úÖ Construct URL based on which dates are provided
    let url = `/generate_report?user_id=${encodeURIComponent(userId)}`;

    if (completedDate) {
        url += `&completed_date=${encodeURIComponent(completedDate)}`;
    } else {
        url += `&from_date=${encodeURIComponent(fromDate)}&to_date=${encodeURIComponent(toDate)}`;
    }

    if (assessmentStatus && assessmentStatus.toLowerCase() !== "all status") {
        url += `&assessment_status=${encodeURIComponent(assessmentStatus)}`;
    }

    if (areaId && areaId.toLowerCase() !== "all") {
        url += `&area=${encodeURIComponent(areaId)}`;
    }

    if (pictureLocation) {
        url += `&picture_location=${encodeURIComponent(pictureLocation)}`;
    }

    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert("Error: " + data.error);
                return;
            }

            populateTable(data);
            generateCharts(data);
        })
        .catch(error => console.error("Error fetching report:", error));
}

function populateTable(data) {
    const tableBody = document.querySelector("#reportTable tbody");
    tableBody.innerHTML = "";

    if (data.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="8" style="text-align:center;">No data found</td></tr>`;
        return;
    }

    data.forEach((row, index) => {
        if (row["Assessment Status"] === "OE Approved") {
            row["User Name"] = "Alok";
        } else if (row["Assessment Status"] === "PM Approved") {
            row["User Name"] = "Mahendra";
        }

        const assessmentId = row["Assessment ID"];
        const pileNo = row["Pile No"];
        const tableId = row["Table ID"];
        const areaId = row["Area ID"];
        const caseType = row["Assessment Case"];
        const userId = document.getElementById("user_id").value;
        const commentId = `C${String(index + 1).padStart(5, '0')}`;  // e.g., C00001

        let imageHTML = '<div style="display: flex; gap: 5px;">';
        for (let i = 1; i <= 4; i++) {
            const imageUrl = `/AssessmentPictures/${assessmentId}/${assessmentId}_${tableId}_Pile${pileNo}_side${i}.jpg`;

            imageHTML += `
                <img src="${imageUrl}" 
                     alt="Side ${i}" 
                     class="thumbnail"
                     onerror="this.style.display='none'; this.insertAdjacentHTML('afterend', '<div style=\\'width:60px;height:60px;display:flex;align-items:center;justify-content:center;border:1px solid #ccc;border-radius:5px;font-size:10px;color:#777\\'>Not Uploaded</div>')"
                     style="width: 60px; height: 60px; object-fit: cover; border-radius: 5px; cursor: pointer;">
            `;
        }
        imageHTML += '</div>';

        const tr = document.createElement("tr");
        tr.setAttribute("data-assessment-id", assessmentId);
        tr.setAttribute("data-table-id", tableId);
        tr.setAttribute("data-pile-no", pileNo);
        
        tr.innerHTML = `
            <td>${row["User Name"]}</td>
            <td>${tableId}</td>
            <td>
                ${pileNo}
                <button type="button" class="comment-icon" 
                onclick="toggleCommentBox('${commentId}', '${userId}', '${areaId}', '${tableId}', '${pileNo}', '${caseType}', '${row["Assessment Status"]}')"
                title="Click to add a comment">üí¨</button>
                <div id="commentBox_${commentId}" class="comment-box" style="display:none; margin-top:5px;">
                    <textarea id="commentText_${commentId}" placeholder="Enter comment..." style="width:100px; height:60px;"></textarea>
                   <button type="button" onclick="submitComment('${commentId}', '${userId}', '${areaId}', '${tableId}', '${pileNo}', '${caseType}', '${row["Assessment Status"]}')">Submit</button>
                </div>
            </td>
            <td>${row["Task Date"]}</td>
            <td>${areaId}</td>
            <td>${row["Assessment Status"]}</td>
            <td>${caseType}</td>
            <td>${imageHTML}</td>
        `;
        tableBody.appendChild(tr);
    });
}

document.addEventListener("click", function (e) {
        if (e.target.classList.contains("thumbnail")) {
            const modal = document.getElementById("imageModal");
            const modalImage = document.getElementById("modalImage");
            modalImage.src = e.target.src;
            modal.style.display = "flex";
        }
    });

    // Close modal
    function closeModal() {
        const modal = document.getElementById("imageModal");
        modal.style.display = "none";
        document.getElementById("modalImage").src = "";
    }
    let currentZoom = 1;

function zoomImage(factor) {
    currentZoom *= factor;
    const modalImage = document.getElementById("modalImage");
    modalImage.style.transform = `scale(${currentZoom})`;
}

function closeModal() {
    const modal = document.getElementById("imageModal");
    modal.style.display = "none";
    const modalImage = document.getElementById("modalImage");
    modalImage.src = "";
    modalImage.style.transform = "scale(1)";
    currentZoom = 1;
}

    // ESC to close modal
    document.addEventListener("keydown", function (e) {
        if (e.key === "Escape") {
            closeModal();
        }
    });

    // Make closeModal usable in inline HTML (onclick)
    window.closeModal = closeModal;

let currentCommentParams = {};

function toggleCommentBox(commentId, userId, areaId, tableId, pileId, caseType, assessmentStatus) {
    // Save current data for submission
    currentCommentParams = {
        commentId,
        userId,
        areaId,
        tableId,
        pileId,
        caseType,
        assessmentStatus
    };

    document.getElementById("modalCommentText").value = ""; // clear previous
    document.getElementById("commentModal").style.display = "block";
}

function cancelModal() {
    document.getElementById("commentModal").style.display = "none";
}

function submitModalComment() {
    const commentText = document.getElementById("modalCommentText").value.trim();
    if (!commentText) {
        alert("Please enter a comment.");
        return;
    }

    //const today = new Date().toISOString().split('T')[0];

    fetch("/submit_comment", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            user_id: currentCommentParams.userId,
            area_id: currentCommentParams.areaId,
            table_id: currentCommentParams.tableId,
            pile_no: currentCommentParams.pileId,
            case_type: currentCommentParams.caseType,
            comment_description: commentText,
            //date_posted: today,
            assessment_status: currentCommentParams.assessmentStatus
        }),
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showCommentPopup(); // your existing popup
            cancelModal(); // close modal
        } else {
            alert("Error: " + result.error);
        }
    })
    .catch(error => {
        console.error("Submission error:", error);
        alert("An error occurred while submitting the comment.");
    });
}


function showCommentPopup() {
    const popup = document.getElementById("commentPopup");
    popup.style.display = "block";

    setTimeout(() => {
        popup.style.display = "none";
    }, 3000);  // Hide after 3 seconds
}


        function generateCharts(data) {
            const statusCounts = { "In Progress": 0, "Completed": 0, "PM Approved": 0, "OE Approved": 0 };
    const caseCounts = { "Case1": 0, "Case2": 0, "Case3": 0, "Case4": 0,  "Not Assessed": 0 };

    // Count occurrences for assessment statuses and cases
    data.forEach(row => {
        let status = row["Assessment Status"] ? row["Assessment Status"].trim() : "In Progress"; // Convert "No Status" to "In progress"
        let caseType = row["Assessment Case"] ? row["Assessment Case"].trim() : "Not Assessed"; // Handle null

        statusCounts[status] = (statusCounts[status] || 0) + 1;
        caseCounts[caseType] = (caseCounts[caseType] || 0) + 1;
    });

    console.log("Status Counts:", statusCounts);
    console.log("Case Counts:", caseCounts);

    const maxCount = Math.max(...Object.values(statusCounts));
    const yMax = maxCount + 5; // Extend range by 5 (adjust as needed)

    // Define colors for each status
    const statusColors = {
        
        "In Progress": "red",
        "Completed": "#FFD700",
        "PM Approved": "blue",
        "OE Approved": "green"
    };

    // Ensure "No Status" is merged into "In progress" and remove "No Status" entry
    if (statusCounts["No Status"]) {
        statusCounts["In Progress"] = (statusCounts["In Progress"] || 0) + statusCounts["No Status"];
        delete statusCounts["No Status"];
    }

    console.log("Updated Status Counts:", statusCounts); // Debugging output


    // Get colors based on available statuses
    const backgroundColors = Object.keys(statusCounts).map(status => statusColors[status] || "purple");

    // Destroy previous charts if they exist
    if (window.statusChartInstance) {
        window.statusChartInstance.destroy();
    }
    if (window.caseChartInstance) {
        window.caseChartInstance.destroy();
    }

    // Create Bar Chart for Assessment Status
    const statusCtx = document.getElementById("statusChart").getContext("2d");

window.statusChartInstance = new Chart(statusCtx, {
    type: "bar",
    data: {
        labels: Object.keys(statusCounts),
        datasets: [{
            data: Object.values(statusCounts),
            backgroundColor: backgroundColors,
            barPercentage: 0.4,  // Adjusts individual bar width (smaller value = thinner bars)
            categoryPercentage: 0.6 // Adjusts space between bars (smaller value = more spacing)
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            x: {
                barPercentage: 0.4,  // Ensures bars remain thin
                categoryPercentage: 0.6 // Adjusts spacing
            },
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1 // Adjust step size if needed
                },
                afterDataLimits: (scale) => {
                    scale.max += 300; // Add 2 extra steps above max value
                }
            }
        },
        plugins: {
            legend: { display: false },
            tooltip: { enabled: true },
            datalabels: {
                anchor: "end",
                align: "top",
                formatter: (value) => value,
                font: { weight: "bold", size: 14 },
                color: "black"
            }
        }
    },
    plugins: [ChartDataLabels] // Required for labels on bars
});


    // Create Pie Chart for Assessment Cases
    const caseCtx = document.getElementById("caseChart").getContext("2d");
window.caseChartInstance = new Chart(caseCtx, {
    type: "pie",
    data: {
        labels: Object.keys(caseCounts),
        datasets: [{
            data: Object.values(caseCounts),
            backgroundColor: ["yellow", "orange", "red","green" ,"gray"]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,  // Allows resizing
        layout: {
            padding: 5  // Reduce padding for a smaller chart
        },
        plugins: {
            legend: {
                position: "bottom",
                labels: {
                    boxWidth: 10, // Reduce legend size
                    font: { size: 10 } // Smaller text
                }
            },
            tooltip: { enabled: true },
            datalabels: {
              formatter: (value) => value === 0 ? '' : value
              , // Show number only
                color: "black",
                font: { weight: "bold", size: 10 } // Smaller labels
            }
        }
    },
    plugins: [ChartDataLabels] // Required for labels
});

}
async function savecasePDF() {
    // üîÅ Get last Sl. No. from backend
    let lastSlNo = 0;
await fetch("/get_last_slno?type=case")  // use "case" if for case pdf
    .then(res => res.json())
    .then(data => {
        lastSlNo = parseInt(data.last_slno);
    });

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF("p", "mm", "a4");

    const currentDate = new Date().toISOString().split("T")[0];
    const userSelect = document.getElementById("user_id");
    const userName = userSelect.options[userSelect.selectedIndex].text.trim().replace(/\s+/g, "_");

    let pageNum = 1;
    addHeader(pageNum);
    let startY = 30;

    const table = document.getElementById("reportTable");
   const headers = ["Sl. No.","Area ID", "Table ID", "Pile No", "Task Date",  "Assessment Status", "Assessment Case"];
const columnWidths = [15, 20, 25, 20, 25, 35, 25];

    let firstPage = true;
    let slNo = lastSlNo + 1;  // üîÅ Start from last + 1
    const totalRows = table.rows.length - 1;

    for (let i = 1; i <= totalRows; i++) {
    const row = table.rows[i];
    let rowData = [slNo]; // Sl. No.

    // Insert Area ID explicitly as 2nd column (assuming it's at row.cells[4])
    rowData.push(row.cells[4].innerText);

// Then push the rest of the columns, skipping the original area ID position to avoid duplicates
for (let j = 1; j < 7; j++) {
    if (j === 4) continue;  // Skip Area ID cell because we already inserted it

    // Special handling for Pile No column (index 3)
    if (j === 2) {
        const pileCell = row.cells[j];
        let pileNo = "";

        if (pileCell.firstChild && pileCell.firstChild.nodeType === Node.TEXT_NODE) {
            // Use only the number part before any button/icon
            pileNo = pileCell.firstChild.textContent.trim();
        } else {
            // Fallback: extract leading digits only
            const match = pileCell.textContent.trim().match(/^\d+/);
            pileNo = match ? match[0] : "";
        }
 // üëà Add this line to print it
        rowData.push(pileNo);
    } else {
        rowData.push(row.cells[j].innerText.trim());
    }
}

        doc.autoTable({
            head: firstPage ? [headers] : undefined,
            body: [rowData],
            startY: startY,
            theme: "grid",
            styles: { fontSize: 10, cellPadding: 2 },
            margin: { left: 10 },
            columnStyles: {
                0: { cellWidth: columnWidths[0] },
                1: { cellWidth: columnWidths[1] },
                2: { cellWidth: columnWidths[2] },
                3: { cellWidth: columnWidths[3] },
                4: { cellWidth: columnWidths[4] },
                5: { cellWidth: columnWidths[5] }
            },
            didDrawPage: () => {
                if (pageNum > 1) addHeader(pageNum);
            }
        });

        startY = doc.lastAutoTable.finalY + 2;

        if (startY + 40 > doc.internal.pageSize.getHeight()) {
            doc.addPage();
            addHeader(++pageNum);
            startY = 30;
        }

        firstPage = false;
        slNo++;
    }

    const caseChart = document.getElementById("caseChart");
    if (caseChart) {
        doc.addPage();
        addHeader(++pageNum);
        doc.setFontSize(14);
        doc.text("Assessment Case Distribution", 10, 30);
        const caseImage = caseChart.toDataURL("image/png");
        doc.addImage(caseImage, "PNG", 10, 40, 180, 90);
    }

    const pdfBlob = doc.output("blob");
    const formData = new FormData();
    const rowCount = table.rows.length - 1;
    const pdfFilename = `Assessment_CaseReport_${currentDate}_${rowCount}Piles.pdf`;

    formData.append("pdf", pdfBlob, pdfFilename);
    formData.append("new_last_slno", slNo - 1);  // üîÅ send updated last slno

    fetch("/savecase_pdf", {
        method: "POST",
        body: formData
    })
        .then(response => response.json())
        .then(data => alert(data.message))
        .catch(error => console.error("Error saving PDF:", error));

    function addHeader(pageNumber) {
        const pageWidth = doc.internal.pageSize.getWidth();
        const title = "BREPL REMEDIAL PROJECT - Assessment Case Reports";

        doc.setFont("helvetica", "bold");
        doc.setFontSize(16);
        const textWidth = doc.getTextWidth(title);
        const centerX = (pageWidth - textWidth) / 2;

        doc.setFillColor(173, 216, 230);
        doc.rect(0, 5, pageWidth, 15, "F");

        doc.setTextColor(0, 0, 0);
        doc.text(title, centerX, 15);
        doc.setFontSize(12);
        doc.text(`Report Date: ${currentDate}`, 10, 25);
        doc.text(`Page ${pageNumber}`, pageWidth - 25, 25);
    }
}

async function saveAsPDF() {
//   async function getRustPercentages(imgTags) {
//     const formData = new FormData();
//     for (let i = 0; i < 4; i++) {
//         if (imgTags[i]) {
//             const blob = await fetch(imgTags[i].src).then(res => res.blob());
//             formData.append(`side${i + 1}`, blob, `side${i + 1}.jpg`);
//         }
//     }

//     const response = await fetch("/analyze_corrosion", {
//         method: "POST",
//         body: formData
//     });

//     const result = await response.json();
    
//     // üî• Use actual per-image rust percentages returned from the backend
//     const perImage = result.per_image || [0, 0, 0, 0];  // fallback if missing

//     return perImage;  // return actual per-image rust %
// }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF("p", "mm", "a4");

    const currentDate = new Date().toISOString().split("T")[0];
    const userSelect = document.getElementById("user_id");
    const userName = userSelect.options[userSelect.selectedIndex].text.trim().replace(/\s+/g, "_");

    let pageNum = 1;
    addHeader(pageNum);
    let startY = 30;

    const table = document.getElementById("reportTable");
    const headers = ["User Name", "Table ID", "Pile No", "Task Date", "Assessment Status", "Assessment Case"];

    for (let i = 1; i < table.rows.length; i++) {
        const row = table.rows[i];

        // Extract text data
        let rowData = [];
        for (let j = 0; j < 6; j++) {
            rowData.push(row.cells[j].innerText);
        }

        // Draw one row
        doc.autoTable({
            head: [headers],
            body: [rowData],
            startY: startY,
            theme: "grid",
            styles: { fontSize: 10, cellPadding: 2 },
            margin: { left: 10 },
            columnStyles: { 4: { cellWidth: 35 }, 5: { cellWidth: 35 } },
            didDrawPage: (data) => {
                if (pageNum > 1) addHeader(pageNum);
            }
        });

        startY = doc.lastAutoTable.finalY + 2;

        // Draw images below the row and send for rust % analysis
        const imgTags = row.cells[6]?.querySelectorAll("img") || [];
        let x = 10;
        const spacing = 45;
        const imgW = 33;
        const imgH = 57;

        // const rustPercents = await getRustPercentages(imgTags);

        for (let j = 0; j < 4; j++) {
            const imgTag = imgTags[j];
            if (imgTag) {
                try {
                    const base64 = await loadImageAsDataURL(imgTag.src);
                    doc.addImage(base64, "JPEG", x, startY, imgW, imgH);

                    doc.setFontSize(8);
                    // doc.text(`${rustPercents[j] || "0"}%`, x + 5, startY + imgH + 5);  // % under image
                } catch (e) {
                    doc.setFontSize(8);
                    doc.text("Image not uploaded", x, startY + 15);
                }
            }
            x += spacing;
        }
        startY += imgH + 10;

        // Page break if needed
        if (startY + 40 > doc.internal.pageSize.getHeight()) {
            doc.addPage();
            addHeader(++pageNum);
            startY = 30;
        }
    }

    // ‚û§ Add Charts (Optional)
    let chartAdded = false;

    const statusChart = document.getElementById("statusChart");
    if (statusChart) {
        if (!chartAdded) {
            doc.addPage();
            addHeader(++pageNum);
            chartAdded = true;
        }
        doc.setFontSize(14);
        doc.text("Assessment Charts", 10, 30);
        const chartImage = statusChart.toDataURL("image/png");
        doc.addImage(chartImage, "PNG", 10, 40, 180, 90);
    }

    const caseChart = document.getElementById("caseChart");
    if (caseChart) {
        doc.addPage();
        addHeader(++pageNum);
        doc.setFontSize(14);
        doc.text("Assessment Case Distribution", 10, 30);
        const caseImage = caseChart.toDataURL("image/png");
        doc.addImage(caseImage, "PNG", 10, 40, 180, 90);
    }

    // ‚û§ Upload PDF to Flask
    const pdfBlob = doc.output("blob");
    const formData = new FormData();
    formData.append("pdf", pdfBlob, `Assessment_Report_${userName}_${currentDate}.pdf`);

    fetch("/save_pdf", {
        method: "POST",
        body: formData
    })
        .then(response => response.json())
        .then(data => alert(data.message))
        .catch(error => console.error("Error saving PDF:", error));

    // ‚û§ Helper to get base64 from image
    function loadImageAsDataURL(url) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.crossOrigin = "anonymous";
            img.onload = () => {
                const canvas = document.createElement("canvas");
                canvas.width = img.width;
                canvas.height = img.height;
                canvas.getContext("2d").drawImage(img, 0, 0);
                resolve(canvas.toDataURL("image/jpeg"));
            };
            img.onerror = reject;
            img.src = url;
        });
    }

    // ‚û§ Header for each page
    function addHeader(pageNumber) {
        const pageWidth = doc.internal.pageSize.getWidth();
        const title = "BREPL REMEDIAL PROJECT - Assessment Reports";

        doc.setFont("helvetica", "bold");
        doc.setFontSize(16);
        const textWidth = doc.getTextWidth(title);
        const centerX = (pageWidth - textWidth) / 2;

        doc.setFillColor(173, 216, 230);
        doc.rect(0, 5, pageWidth, 15, "F");

        doc.setTextColor(0, 0, 0);
        doc.text(title, centerX, 15);
        doc.setFontSize(12);
        doc.text(`Report Date: ${currentDate}`, 10, 25);
        doc.text(`Page ${pageNumber}`, pageWidth - 25, 25);
    }
}
function removeEmoji(text) {
    return text.replace(/[\u{1F600}-\u{1F6FF}\u{1F300}-\u{1F5FF}\u{1F900}-\u{1F9FF}]/gu, '');
}

function generateAssSLNOFile() {
    const table = document.getElementById("reportTable");
    const rows = table.rows;

    let slnoData = [];

    for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        const slno = i;
        const assessmentId = row.getAttribute("data-assessment-id") || "";
        const tableId = row.cells[1].innerText.trim();
        const pileNo = removeEmoji(row.cells[2].innerText.trim());

        const taskDate = row.cells[3]?.innerText.trim();      // Task Date
        const areaId = row.cells[4]?.innerText.trim();        // Area ID
        const assessmentCase = row.cells[6]?.innerText.trim(); // ‚úÖ Case column (update index if needed)

        slnoData.push({
            slno: slno,
            assessment_id: assessmentId,
            table_id: tableId,
            pile_no: pileNo,
            area_id: areaId,
            task_date: taskDate,
            assessment_case: assessmentCase    // ‚úÖ Include case in request
        });
    }

    fetch("/generate_ass_slno_txt", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify(slnoData)
    })
    .then(response => response.json())
    .then(data => alert(data.message))
    .catch(error => console.error("Error generating SLNO file:", error));
}

function loadImageAsDataURL(url) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.crossOrigin = "anonymous";
            img.onload = () => {
                const canvas = document.createElement("canvas");
                canvas.width = img.width;
                canvas.height = img.height;
                canvas.getContext("2d").drawImage(img, 0, 0);
                resolve(canvas.toDataURL("image/jpeg"));
            };
            img.onerror = reject;
            img.src = url;
        });
    }
async function saveFIPDF() {

        let lastSlNo = 0;
await fetch("/get_last_slno?type=normal")  // use "case" if for case pdf
    .then(res => res.json())
    .then(data => {
        lastSlNo = parseInt(data.last_slno);
    });
        
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({
        orientation: "landscape",
        unit: "mm",
        format: [420, 210] // A3 Landscape
    });

    const currentDate = new Date().toISOString().split("T")[0];
    const userSelect = document.getElementById("user_id");
    const userName = userSelect.options[userSelect.selectedIndex].text.trim().replace(/\s+/g, "_");

    const table = document.getElementById("reportTable");

    const headers = [
        { content: "Sl. No.", rowSpan: 2 },
        { content: "Table ID", rowSpan: 2 },
        { content: "Pile No", rowSpan: 2 },
        { content: "Date of Assessment", rowSpan: 2 },
        { content: "CASE 1", colSpan: 3 },
        { content: "CASE 2", colSpan: 2 },
        { content: "CASE 3", colSpan: 3 },
        { content: "CASE 4", colSpan: 1 },
        { content: "Assessment Status", rowSpan: 2 },
        { content: "As per FI", colSpan: 4  },
        { content: "Remarks", rowSpan: 2 }
    ];

    const subHeaders = [
       "Lost Galvanized", "Damages in Bare Steel", "Rusty Areas",
        "Partially or completely lost galvanized coating", "Rusty Areas", 
        "Partially lost galvanized coating", "Bare steel unaffected", "Few red spots or rusty areas",
        "No red spots or rusty",
        "Case1","Case2","Case3","Case4",
        "Assessment Status", "Classification as per Indisolar", "Recommendation as per OE", "Remarks"
    ];

    let pageNum = 1;
    let setsOnPage = 0;  // Track how many sets printed on current page
    let slNo = lastSlNo + 1;

for (let i = 1; i < table.rows.length; i++) {
        let isFirstSet = setsOnPage === 0;
        let startY = isFirstSet ? 30 : 115;  // Start position for row data
        let startX = 10; 

        if (setsOnPage === 0) {
            addHeader(pageNum++);  // Add header for the first set
        }

        const row = table.rows[i];
        const cells = row.cells;
       
const rowData = [
    slNo++,  // Sl. No.
    cells[1]?.innerText || "",

    // ‚úÖ Cleaned Pile No
    (() => {
        const pileCell = cells[2];
        if (!pileCell) return "";
        if (pileCell.firstChild && pileCell.firstChild.nodeType === Node.TEXT_NODE) {
            return pileCell.firstChild.textContent.trim();
        }
        const match = pileCell.textContent.trim().match(/^\d+/);
        return match ? match[0] : "";
    })(),

    cells[3]?.innerText || "",

    cells[4]?.querySelector(".case1_zinc")?.innerText || "",
    cells[4]?.querySelector(".case1_bare")?.innerText || "",
    cells[4]?.querySelector(".case1_rust")?.innerText || "",

    cells[5]?.querySelector(".case2_zinc")?.innerText || "",
    cells[5]?.querySelector(".case2_bare")?.innerText || "",

    cells[6]?.querySelector(".case3_zinc")?.innerText || "",
    cells[6]?.querySelector(".case3_bare")?.innerText || "",
    cells[6]?.querySelector(".case3_rust")?.innerText || "",

    cells[7]?.querySelector(".case4_zinc")?.innerText || "",

    (cells[5]?.innerText.trim() === "OE Approved" ? "Completed" : cells[5]?.innerText.trim()) || "",

   
    cells[9]?.innerText || "",
    cells[10]?.innerText || "",
    cells[11]?.innerText || ""
];

    const caseCheckboxColumns = [4, 5, 6, 7, 8, 9, 10, 11, 12];
    const caseCircleColumns = [14, 15, 16, 17];

const tableResult = doc.autoTable({
    head: [headers, subHeaders],
    body: [rowData],
    startY: startY,
    theme: "grid",
    styles: {
        fontSize: 8,
        cellPadding: 1,
        overflow: 'linebreak',
        lineWidth: 0.1,
        lineColor: [0, 0, 0],
        halign: 'center',
        valign: 'middle'
    },
    headStyles: {
        fillColor: [200, 200, 200],
        textColor: [0, 0, 0],
        fontStyle: 'bold'
    },
    margin: { left: 5, right: 5 },

    /** ‚úÖ Draw light-colored checkbox inside CASE columns */
    didDrawCell: function (data) {
    const colIndex = data.column.index;

    if ((caseCheckboxColumns.includes(colIndex) || caseCircleColumns.includes(colIndex)) && data.section === 'body') {
        const checkboxSize = 4;
        const x = data.cell.x + data.cell.width / 2 - checkboxSize / 2;
        const y = data.cell.y + data.cell.height / 2 - checkboxSize / 2;

        doc.setDrawColor(150); // Light gray
        doc.setLineWidth(0.3);

        if (caseCheckboxColumns.includes(colIndex)) {
            // Draw square checkbox
            doc.rect(x, y, checkboxSize, checkboxSize);
        } else if (caseCircleColumns.includes(colIndex)) {
            // Just draw circle, no tick
            const radius = checkboxSize / 2;
            doc.circle(x + radius, y + radius, radius);
        }
    }
}


});

    const imgTags = cells[7]?.querySelectorAll("img") || [];
    const formDataCorrosion = new FormData();
    const imageY = tableResult.lastAutoTable.finalY + 2; 
    for (let k = 0; k < 4; k++) {
        if (imgTags[k]) {
            try {
                const blob = await fetch(imgTags[k].src).then(res => res.blob());
                formDataCorrosion.append(`side${k + 1}`, blob, `side${k + 1}.jpg`);
            } catch (e) {
                console.warn(`Error loading image side${k + 1}:`, e);
            } 
        }
    }

       const imageWidth = 33;
const imageHeight = 57;
const blockGap = 70;
let currentX = startX;

for (let imgIndex = 0; imgIndex < 16; imgIndex++) {
    const imgTag = imgTags[imgIndex];
    if (imgTag && imgTag.src) {
        try {
            const dataURL = await loadImageAsDataURL(imgTag.src);

            // Draw image
            doc.addImage(dataURL, "JPEG", currentX, imageY, imageWidth, imageHeight);

            // Add "Side n" label below image
            const labelText = `Side ${imgIndex + 1}`;
            doc.setFontSize(8);
            doc.text(labelText, currentX + (imageWidth / 2) - 7, imageY + imageHeight + 5);

            currentX += blockGap;
        } catch (err) {
            console.warn(`Error loading image ${imgIndex + 1}:`, err);
        }
    }
}


    setsOnPage++;
const isLastRow = i === table.rows.length - 1;
if (setsOnPage === 2 && !isLastRow) {
    setsOnPage = 0;
    doc.addPage(); // Only add page if not last
}

}

const pdfPageWidth = 420; // A3 width in mm (landscape)
const pdfPageHeight = 210; // A3 height in mm (landscape)
const imageWidth = 180;    // Image width (adjustable)
const imageHeight = 90;    // Image height (adjustable)
const centeredX = (pdfPageWidth - imageWidth) / 2; // Centering horizontally

let chartAdded = false;

// Add Status Chart
const statusChart = document.getElementById("statusChart");
if (statusChart) {
    if (!chartAdded) {
        doc.addPage();
        addHeader(++pageNum);
        chartAdded = true;
    }
    doc.setFontSize(14);
    doc.text("Assessment Charts", pdfPageWidth / 2, 30, { align: "center" });

    const chartImage = statusChart.toDataURL("image/png");
    doc.addImage(chartImage, "PNG", centeredX, 40, imageWidth, imageHeight);
}

// Add Case Distribution Chart
const caseChart = document.getElementById("caseChart");
if (caseChart) {
    doc.addPage();
    addHeader(++pageNum);
    doc.setFontSize(14);
    doc.text("Assessment Case Distribution", pdfPageWidth / 2, 30, { align: "center" });

    const caseImage = caseChart.toDataURL("image/png");
    doc.addImage(caseImage, "PNG", centeredX, 40, imageWidth, imageHeight);
}
function loadLogoImage(callback) {
    const img = new Image();
    img.src = '/static/images/logo.png'; // Adjust extension if it's .jpg or .jpeg
    img.onload = function () {
        const canvas = document.createElement("canvas");
        canvas.width = img.width;
        canvas.height = img.height;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0);
        const base64 = canvas.toDataURL("image/png");
        callback(base64);
    };
}
loadLogoImage(function(logoBase64) {
    generatePDF(logoBase64); // call your PDF generation function with the logo
});

    // Save to server
    const pdfBlob = doc.output("blob");
    const formData = new FormData();
    
    formData.append("pdf", pdfBlob, `Assessment_Report_${currentDate}.pdf`);
    formData.append("new_last_slno", slNo - 1);
    fetch("/save_pdf", {
        method: "POST",
        body: formData
    })
        .then(response => response.json())
        .then(data => alert(data.message))
        .catch(error => console.error("Error saving PDF:", error));
        function addHeader(pageNumber) {
    const pageWidth = doc.internal.pageSize.getWidth();
    const title = "BREPL REMEDIAL PROJECT - Assessment Report";

    doc.setFont("helvetica", "bold");
    doc.setFontSize(16); // Set font size before measuring
    const textWidth = doc.getTextWidth(title); // Now get correct width
    const centerX = (pageWidth - textWidth) / 2;

    // Draw background rectangle
    doc.setFillColor(173, 216, 230); // Light blue
    doc.rect(0, 5, pageWidth, 15, "F");

    // Add title
    doc.setTextColor(0, 0, 0);
    doc.text(title, centerX, 15);

    // Add report date and page number
    doc.setFontSize(12);
    doc.text(`Report Date: ${currentDate}`, 10, 25);
    doc.text(`Page ${pageNumber}`, pageWidth - 25, 25);
}


function loadImageAsDataURL(url) {
    return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = "Anonymous";
        img.onload = () => {
            const canvas = document.createElement("canvas");
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0);

            // üîπ Keep same width/height but reduce file MB by lowering JPEG quality
            const compressedDataUrl = canvas.toDataURL("image/jpeg", 0.4); 
            // 0.5 = 50% quality (adjust 0.4‚Äì0.7 range for balance)

            resolve(compressedDataUrl);
        };
        img.onerror = reject;
        img.src = url;
    });
}

}

    function loadImageAsDataURL(url) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.crossOrigin = "Anonymous";
            img.onload = () => {
                const canvas = document.createElement("canvas");
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext("2d");
                ctx.drawImage(img, 0, 0);
                resolve(canvas.toDataURL("image/jpeg"));
            };
            img.onerror = reject;
            img.src = url;
        });
    }


function toggleSubMenu() {
        const submenu = document.querySelector('.submenu');
        const arrow = document.querySelector('.arrow');

        submenu.classList.toggle('hidden');
        arrow.classList.toggle('rotate');
    }
      document.addEventListener("DOMContentLoaded", () => {
        const burgerButton = document.getElementById("burger-button");
        const closeButton = document.getElementById("close-button");
        const sidebar = document.getElementById("sidebar");

        burgerButton.addEventListener("click", () => {
          sidebar.classList.toggle("open");
          sidebar.classList.toggle("closed");
        });

        closeButton.addEventListener("click", () => {
          sidebar.classList.add("closed");
          sidebar.classList.remove("open");
        });

        document.querySelectorAll(".menu-item").forEach((item) => {
          item.addEventListener("click", () => {
            item.classList.toggle("open");
          });
        });
      });

    </script>
<!-- Image Modal for Preview -->
<div id="imageModal" onclick="closeModal()" style="
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background-color: rgba(0, 0, 0, 0.85);
    justify-content: center;
    align-items: center;
    z-index: 9999;
    flex-direction: column;
">
    <img id="modalImage" style="
        max-width: 90%;
        max-height: 90%;
        border: 4px solid #fff;
        border-radius: 10px;
        box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
    ">
    <span style="
        margin-top: 10px;
        color: white;
        font-size: 16px;
        cursor: pointer;
        text-decoration: underline;
    ">Click anywhere to close</span>

<div style="position: relative; display: flex; align-items: center;">
  <!-- Zoom Buttons -->
  <div style="display: flex; flex-direction: row; gap: 10px; margin-right: 15px;">
      <button onclick="zoomImage(1.2); event.stopPropagation();" 
              style="font-size: 24px; padding: 5px 10px; cursor: pointer;">Ôºã</button>
      <button onclick="zoomImage(0.8); event.stopPropagation();" 
              style="font-size: 24px; padding: 5px 10px; cursor: pointer;">Ôºç</button>
  </div>
</div>

</body>
</html>
